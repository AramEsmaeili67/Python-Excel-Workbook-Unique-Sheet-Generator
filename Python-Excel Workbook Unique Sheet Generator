import openpyxl
import re
from openpyxl.utils import get_column_letter

def sanitize_sheet_name(name):
    # Remove invalid characters from sheet name
    return re.sub(r'[\\/:\*\?"<>\|]', '', name)[:31]  # Limit to 31 characters as per Excel limit

def create_sheets_from_unique_items(file_path, sheet_name, column_letter):
    # Load the workbook and list all sheet names
    workbook = openpyxl.load_workbook(file_path)
    print("Sheets in the workbook:")
    print(workbook.sheetnames)

    if sheet_name not in workbook.sheetnames:
        print(f"Sheet '{sheet_name}' not found.")
        return
    
    sheet = workbook[sheet_name]

    # Find the unique items in the specified column
    unique_items = set()
    for row in sheet.iter_rows(min_row=2, max_col=openpyxl.utils.column_index_from_string(column_letter), values_only=True):
        if row[openpyxl.utils.column_index_from_string(column_letter) - 1]:
            unique_items.add(row[openpyxl.utils.column_index_from_string(column_letter) - 1])

    if not unique_items:
        print(f"No unique items found in column {column_letter}.")
        return

    # Create a new sheet for each unique item
    for item in unique_items:
        # Sanitize the sheet name
        sanitized_name = sanitize_sheet_name(item)
        
        if sanitized_name in workbook.sheetnames:
            target_sheet = workbook[sanitized_name]
        else:
            target_sheet = workbook.create_sheet(title=sanitized_name)

        # Copy the header
        for col_num, col in enumerate(sheet.iter_cols(min_row=1, max_row=1, values_only=True), start=1):
            target_sheet.cell(row=1, column=col_num, value=col[0])

        # Copy the rows corresponding to the current item
        for row in sheet.iter_rows(min_row=2, values_only=True):
            if row[openpyxl.utils.column_index_from_string(column_letter) - 1] == item:
                target_sheet.append(row)
    
    # Save the workbook
    workbook.save(file_path)
    print(f"New sheet(s) created based on the unique items.")

# Specify the file path, sheet name, and the column letter
file_path = r'C:\Users\AramEsmaeili\OneDrive - CloseReach Ltd\Documents\pandas app\dataPY.xlsm'
sheet_name = 'TIMESHEET'  # Change to your sheet name
column_letter = 'A'  # Change to your column letter

create_sheets_from_unique_items(file_path, sheet_name, column_letter)
